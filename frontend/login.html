<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SHM Report Generator â€” Login</title>
<style>
  *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
  :root{
    --bg:#f5f7fa;--surface:#fff;--border:#e1e5eb;
    --text:#1a1a2e;--text-muted:#6b7280;
    --primary:#2563eb;--primary-hover:#1d4ed8;--primary-disabled:#93b4f5;
    --error:#dc2626;--error-bg:#fef2f2;--error-border:#fecaca;
    --radius:8px;
  }
  body{
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
    background:var(--bg);color:var(--text);
    min-height:100vh;display:flex;align-items:center;justify-content:center;
    padding:24px;
  }
  .card{
    background:var(--surface);border:1px solid var(--border);
    border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.08);
    width:100%;max-width:400px;padding:36px 32px;
  }
  .lock-icon{
    width:48px;height:48px;margin:0 auto 16px;display:flex;
    align-items:center;justify-content:center;
    background:#eff6ff;border-radius:50%;color:var(--primary);
  }
  .lock-icon svg{width:24px;height:24px}
  h1{font-size:1.25rem;font-weight:600;text-align:center;margin-bottom:4px}
  .subtitle{color:var(--text-muted);font-size:.85rem;text-align:center;margin-bottom:28px}

  label{display:block;font-size:.8rem;font-weight:500;margin-bottom:6px;color:var(--text-muted)}
  input[type=text],input[type=password]{
    width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:var(--radius);
    font-size:.9rem;color:var(--text);background:var(--surface);
    outline:none;transition:border-color .15s;
  }
  input:focus{border-color:var(--primary)}
  .field{margin-bottom:16px}

  button{
    width:100%;padding:11px 18px;border:none;border-radius:var(--radius);
    font-size:.9rem;font-weight:500;cursor:pointer;
    display:inline-flex;align-items:center;justify-content:center;gap:8px;
    transition:background .15s,opacity .15s;
    margin-top:8px;
  }
  .btn-primary{background:var(--primary);color:#fff}
  .btn-primary:hover:not(:disabled){background:var(--primary-hover)}
  .btn-primary:disabled{background:var(--primary-disabled);cursor:not-allowed}

  .spinner{
    width:16px;height:16px;border:2px solid rgba(255,255,255,.35);
    border-top-color:#fff;border-radius:50%;
    animation:spin .6s linear infinite;
  }
  @keyframes spin{to{transform:rotate(360deg)}}

  .msg{
    margin-top:16px;padding:10px 14px;border-radius:var(--radius);
    font-size:.85rem;line-height:1.45;display:none;text-align:center;
  }
  .msg.error{display:block;background:var(--error-bg);border:1px solid var(--error-border);color:var(--error)}

  .show-pw{
    display:flex;align-items:center;gap:6px;margin-top:8px;
    font-size:.78rem;color:var(--text-muted);cursor:pointer;user-select:none;
  }
  .show-pw input{width:auto;margin:0}
</style>
</head>
<body>

<div class="card">
  <div class="lock-icon">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 1 0-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 0 0 2.25-2.25v-6.75a2.25 2.25 0 0 0-2.25-2.25H6.75a2.25 2.25 0 0 0-2.25 2.25v6.75a2.25 2.25 0 0 0 2.25 2.25Z" />
    </svg>
  </div>
  <h1>SHM Report Generator</h1>
  <p class="subtitle">Sign in to access the report engine</p>

  <form id="loginForm" onsubmit="handleLogin(event)">
    <div class="field">
      <label for="username">Username</label>
      <input type="text" id="username" autocomplete="username" required autofocus>
    </div>
    <div class="field">
      <label for="password">Password</label>
      <input type="password" id="password" autocomplete="current-password" required>
      <label class="show-pw">
        <input type="checkbox" onchange="togglePassword(this)"> Show password
      </label>
    </div>
    <button type="submit" class="btn-primary" id="btnLogin">Sign In</button>
  </form>

  <div class="msg" id="msg"></div>

  <div style="text-align:center;margin-top:20px;font-size:.82rem;color:#6b7280">
    Don't have an account? <a href="/register" style="color:#2563eb;text-decoration:none;font-weight:500">Create one</a>
  </div>
</div>

<script>
function togglePassword(cb) {
  const pw = document.getElementById("password");
  pw.type = cb.checked ? "text" : "password";
}

async function handleLogin(e) {
  e.preventDefault();
  const btn = document.getElementById("btnLogin");
  const msg = document.getElementById("msg");
  const username = document.getElementById("username").value.trim();
  const password = document.getElementById("password").value;

  if (!username || !password) {
    msg.textContent = "Please enter both username and password.";
    msg.className = "msg error";
    return;
  }

  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Signing in\u2026';
  msg.className = "msg";

  try {
    const res = await fetch("/api/v1/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "same-origin",
      body: JSON.stringify({ username, password }),
    });
    const data = await res.json();

    if (!res.ok) {
      throw new Error(data.error || "Login failed");
    }

    // Redirect to main app on success
    window.location.href = "/";
  } catch (err) {
    msg.textContent = err.message;
    msg.className = "msg error";
    document.getElementById("password").value = "";
    document.getElementById("password").focus();
  } finally {
    btn.disabled = false;
    btn.innerHTML = "Sign In";
  }
}

// If already authenticated, redirect immediately
fetch("/api/v1/auth/check", { credentials: "same-origin" })
  .then(r => { if (r.ok) window.location.href = "/"; });
</script>

</body>
</html>
